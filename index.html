<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>ç¾å®¢éº—çˆ¾æ¥­ç¸¾å ±è¡¨</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --primary: #4e54c8;
    --primary-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --bg-color: #f2f4f8;
    --card-bg: #ffffff;
    --text-main: #2d3436;
    --text-sub: #636e72;
    --shadow: 0 4px 20px rgba(0,0,0,0.08);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif; 
    background: var(--bg-color); 
    margin: 0; padding: 0; 
    font-size: 16px; color: var(--text-main);
    padding-bottom: 60px;
  }

  header {
    background: var(--primary-grad);
    padding: 25px 20px 40px 20px; color: white; text-align: center;
    border-bottom-left-radius: 24px; border-bottom-right-radius: 24px;
    box-shadow: 0 4px 15px rgba(78, 84, 200, 0.4); margin-bottom: -20px;
  }
  header h2 { margin: 0; font-size: 26px; font-weight: 800; letter-spacing: 1px; }

  .container { width: 94%; max-width: 600px; margin: 0 auto; position: relative; z-index: 10; }

  .card {
    background: var(--card-bg); border-radius: 16px; padding: 20px;
    box-shadow: var(--shadow); margin-bottom: 16px;
  }

  .input-label { font-size: 14px; color: var(--text-sub); margin-bottom: 6px; display: block; font-weight: bold; }
  
  input[type="date"] {
    width: 100%; height: 56px; font-size: 18px; padding: 0 12px;
    border: 1px solid #ddd; border-radius: 10px; background: #fdfdfd;
    outline: none; -webkit-appearance: none; color: #333; margin-bottom: 12px;
  }
  input[type="date"]:focus { border-color: #764ba2; background: #fff; }

  .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px; }
  .btn-full { grid-column: span 2; }
  
  button {
    border: none; border-radius: 12px; font-size: 16px; font-weight: 700;
    height: 56px; cursor: pointer; background: #eef1f6; color: #555;
    width: 100%; transition: 0.1s; display: flex; align-items: center; justify-content: center;
  }
  button.primary {
    background: var(--primary-grad); color: white; font-size: 18px;
    box-shadow: 0 6px 15px rgba(102, 126, 234, 0.3);
  }
  button:active { transform: scale(0.97); opacity: 0.9; }

  .section-title { font-size: 18px; font-weight: 800; margin: 25px 4px 10px 4px; color: #333; }
  
  .total-card { background: var(--primary-grad); color: white; text-align: center; }
  .total-val { font-size: 36px; font-weight: 800; margin: 5px 0 15px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
  .total-stats {
    display: grid; grid-template-columns: 1fr 1fr 1fr;
    background: rgba(255,255,255,0.2); border-radius: 10px; padding: 12px; backdrop-filter: blur(4px);
  }
  .stat-item { border-right: 1px solid rgba(255,255,255,0.3); }
  .stat-item:last-child { border: none; }
  .s-val { font-size: 18px; font-weight: 700; display: block; }
  .s-lbl { font-size: 13px; opacity: 0.9; }

  .floor-item {
    padding: 18px; background: white; border-radius: 12px;
    margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    cursor: pointer; border-left: 5px solid #764ba2;
  }
  .floor-item:active { background: #fafafa; }
  .f-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .f-name { font-size: 20px; font-weight: 700; color: #333; }
  .f-amount { font-size: 22px; font-weight: 800; color: #764ba2; }
  .f-sub { font-size: 14px; color: #666; display: flex; justify-content: space-between; }

  .back-btn { 
    background: #e0e0e0; color: #333; height: 44px; width: auto; 
    padding: 0 20px; margin-bottom: 15px; border-radius: 22px; 
  }

  .order-card {
    background: white; border-radius: 12px; padding: 16px; margin-bottom: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.06); border: 1px solid #eee;
  }
  .ord-header { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #eee; }
  .ord-row { display: flex; justify-content: space-between; margin-bottom: 4px; align-items: baseline; }
  .ord-id { font-weight: 800; font-size: 16px; color: #333; }
  .ord-total { font-weight: 800; font-size: 18px; color: #764ba2; }
  .ord-meta { font-size: 14px; color: #666; }

  .tbl-header {
    display: flex; padding: 6px 0; border-bottom: 2px solid #f0f0f0;
    font-size: 13px; color: #888; font-weight: bold; margin-bottom: 6px;
  }
  .tbl-row {
    display: flex; padding: 8px 0; border-bottom: 1px solid #f9f9f9;
    font-size: 14px; color: #333; align-items: center;
  }
  .tbl-row:last-child { border-bottom: none; }

  .c1 { width: 18%; font-size: 12px; color: #666; word-break: break-all; padding-right: 2px; }
  .c2 { width: 34%; font-weight: 600; line-height: 1.3; padding-right: 4px; }
  .c3 { width: 10%; text-align: center; }
  .c4 { width: 18%; text-align: right; font-size: 13px; }
  .c5 { width: 20%; text-align: right; font-weight: 700; }
  .disc-txt { font-size: 12px; color: #e53935; text-align: right; margin-top: 2px; }

  #loading { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(255,255,255,0.9); z-index: 999; 
    display: none; justify-content: center; align-items: center; flex-direction: column;
  }
  .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: #764ba2; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
  @keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<header>
  <h2>ç¾å®¢éº—çˆ¾</h2>
  <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">éŠ·å”®æ¥­ç¸¾å ±è¡¨</div>
</header>

<div class="container">
  
  <div class="card" id="queryCard">
    <label class="input-label">é–‹å§‹æ—¥æœŸ</label>
    <input type="date" id="startDate">
    <label class="input-label">çµæŸæ—¥æœŸ</label>
    <input type="date" id="endDate">
    
    <div class="btn-grid">
      <button class="primary btn-full" onclick="getReport()">ğŸ” æŸ¥è©¢æ¥­ç¸¾</button>
      <button onclick="getToday()">ä»Šå¤©</button>
      <button onclick="getYesterday()">æ˜¨å¤©</button>
      <button class="btn-full" onclick="getThisMonth()">ğŸ“… æœ¬æœˆç´¯ç©</button>
    </div>
  </div>

  <div id="result"></div>
  
  <div class="card" id="chartCard" style="display:none;">
    <canvas id="chart" height="250"></canvas>
  </div>
</div>

<div id="loading">
  <div class="spinner"></div>
  <div style="font-weight:bold; color:#555;">è™•ç†ä¸­...</div>
</div>

<script>
// ===============================================
// âœ… è¨­å®šï¼šè«‹å¡«å…¥æ‚¨çš„ GAS éƒ¨ç½²ç¶²å€ (exec çµå°¾)
// ===============================================
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzzeldQQQxhFEFTjlB250nRxSTyDzQzgEEPukZAbm4dzfpUAPK_g5W_RP30ScyNggHviw/exec";

let chart;

// === API å‘¼å«å‡½å¼ (å–ä»£ google.script.run) ===
async function callApi(payload) {
  try {
    const res = await fetch(GAS_API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });
    return await res.json();
  } catch (e) {
    console.error(e);
    return { error: 'é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯' };
  }
}

// === åŠŸèƒ½å€ ===
async function getReport() {
  const s = document.getElementById("startDate").value;
  const e = document.getElementById("endDate").value;
  if(!s||!e) return alert("è«‹é¸æ“‡æ—¥æœŸå€é–“");
  
  showLoading(true);
  const data = await callApi({ op: 'report', startDate: s, endDate: e });
  renderReport(data);
}

function getToday() {
  const t = new Date();
  const todayStr = fmtDate(t);
  document.getElementById("startDate").value = todayStr;
  document.getElementById("endDate").value = todayStr;
  getReport();
}

function getYesterday() {
  const d = new Date(); d.setDate(d.getDate()-1);
  const y = fmtDate(d);
  document.getElementById("startDate").value = y;
  document.getElementById("endDate").value = y;
  getReport();
}

function getThisMonth() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = now;
  
  document.getElementById("startDate").value = fmtDate(start);
  document.getElementById("endDate").value = fmtDate(end);
  getReport();
}

function fmtDate(d) {
    // è§£æ±ºæ™‚å€å•é¡Œï¼Œç¢ºä¿æ—¥æœŸæº–ç¢º
    const offset = d.getTimezoneOffset() * 60000;
    return new Date(d.getTime() - offset).toISOString().split('T')[0];
}

function showLoading(b) {
  document.getElementById("loading").style.display = b ? "flex" : "none";
}

// === æ¸²æŸ“ç¸½è¡¨ ===
function renderReport(data) {
  showLoading(false);
  if(data.error) {
    document.getElementById("result").innerHTML = `<div class="card" style="text-align:center; padding:30px; color:red;">âŒ ${data.error}</div>`;
    return;
  }
  
  const res = document.getElementById("result");
  
  // 1. åˆè¨ˆ
  let html = `<div class="section-title">ç¸½è¨ˆæ¦‚è¦½ (${data.start} ~ ${data.end})</div>`;
  html += `
    <div class="card total-card">
      <div style="font-size:14px; opacity:0.9;">ç¸½éŠ·å”®é‡‘é¡</div>
      <div class="total-val">$${data.totalAmount.toLocaleString()}</div>
      <div class="total-stats">
        <div class="stat-item"><span class="s-val">${data.totalCount}</span><span class="s-lbl">ç­†æ•¸</span></div>
        <div class="stat-item"><span class="s-val">${data.totalQty}</span><span class="s-lbl">ä»¶æ•¸</span></div>
        <div class="stat-item"><span class="s-val">$${data.totalCount?Math.round(data.totalAmount/data.totalCount).toLocaleString():0}</span><span class="s-lbl">å®¢å–®</span></div>
      </div>
    </div>
  `;
  
  // 2. é–€å¸‚åˆ—è¡¨
  html += `<div class="section-title">é–€å¸‚æ˜ç´°</div>`;
  const floors = Object.keys(data.floors);
  if(floors.length === 0) {
    html += `<div class="card" style="text-align:center; color:#999;">ç„¡è³‡æ–™</div>`;
  } else {
    floors.forEach(f => {
      const d = data.floors[f];
      const staff = d.staff && d.staff.length ? d.staff.join("ã€") : "â€”";
      html += `
        <div class="floor-item" onclick="showDetails('${f}','${data.start}','${data.end}')">
          <div class="f-top">
            <span class="f-name">${f}</span>
            <span class="f-amount">$${d.total.toLocaleString()}</span>
          </div>
          <div class="f-sub">
            <span>ç­†æ•¸ ${d.count} / ä»¶æ•¸ ${d.qty}</span>
            <span style="color:#764ba2; font-weight:bold;">æŸ¥çœ‹æ˜ç´° á³</span>
          </div>
          <div style="margin-top:6px; font-size:13px; color:#888; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">äººå“¡ï¼š${staff}</div>
        </div>
      `;
    });
  }
  res.innerHTML = html;
  
  document.getElementById("chartCard").style.display="block";
  drawChart(data);
}

function drawChart(data){
  const ctx = document.getElementById("chart").getContext("2d");
  const lbls = Object.keys(data.floors);
  const sales = lbls.map(k=>data.floors[k].total);
  const qtys = lbls.map(k=>data.floors[k].qty);
  
  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:"bar",
    data:{
      labels:lbls,
      datasets:[
        { label:"é‡‘é¡", data:sales, backgroundColor:"#667eea", borderRadius:6, yAxisID:'y' },
        { label:"ä»¶æ•¸", data:qtys, type:"line", borderColor:"#ff7675", borderWidth:3, tension:0.3, yAxisID:'y1' }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{
        x:{ grid:{display:false}, ticks:{font:{size:13}} },
        y:{ beginAtZero:true, ticks:{callback:v=>'$'+v/1000+'k'} },
        y1:{ beginAtZero:true, position:'right', grid:{display:false} }
      }
    }
  });
}

// === æ˜ç´°é  (æ”¹ç”¨ API) ===
async function showDetails(floor,start,end){
  showLoading(true);
  // å‘¼å« API å–å¾—æ˜ç´°
  const orders = await callApi({ op: 'detail', floor: floor, startDate: start, endDate: end });
  renderDetail(floor, orders, start, end);
  showLoading(false);
}

function renderDetail(floor,orders,start,end){
  document.getElementById("chartCard").style.display="none";
  window.scrollTo(0,0);
  
  let html = `
    <button class="back-btn" onclick="getReport()">â¬… è¿”å›ç¸½è¡¨</button>
    <div class="section-title" style="margin-top:0;">${floor}</div>
    <div style="margin:-5px 5px 15px 5px; font-size:14px; color:#666;">${start} ~ ${end} (å…± ${orders.length} ç­†)</div>
  `;

  if(!orders || orders.length===0){
    html+=`<div class="card" style="text-align:center; padding:30px;">ç„¡æ˜ç´°è³‡æ–™</div>`;
    document.getElementById("result").innerHTML=html; return;
  }

  orders.forEach(o => {
    const total = Math.round(o.total).toLocaleString();
    
    html += `<div class="order-card">`;
    
    html += `
      <div class="ord-header">
        <div class="ord-row">
          <span class="ord-id">è¨‚å–®ï¼š${o.id}</span>
          <span class="ord-total">ç¸½è¨ˆï¼š${total}</span>
        </div>
        <div class="ord-meta">æ™‚é–“ï¼š${o.time}</div>
        <div class="ord-meta">éŠ·å”®ï¼š${o.staff||"â€”"} ${o.remark ? "ï½œ å‚™è¨»ï¼š"+o.remark : ""}</div>
      </div>
    `;

    html += `
      <div class="tbl-header">
        <div class="c1">æ–™è™Ÿ</div>
        <div class="c2">å•†å“</div>
        <div class="c3">æ•¸é‡</div>
        <div class="c4">å–®åƒ¹</div>
        <div class="c5">å°è¨ˆ</div>
      </div>
    `;

    html += `<div>`;
    o.items.forEach(item => {
      const qty = item.G || "";
      const price = item.H || "";
      const sub = item.I ? parseFloat(item.I).toLocaleString() : (item.I||"");
      const disc = item.D ? parseFloat(item.D) : 0;
      
      html += `
        <div class="tbl-row">
          <div class="c1">${item.C||""}</div>
          <div class="c2">${item.F||""}</div>
          <div class="c3">${qty}</div>
          <div class="c4">${price}</div>
          <div class="c5">${sub}</div>
        </div>
      `;
      if(disc) {
        html += `<div class="disc-txt">NTï¼š$${disc}</div>`;
      }
    });
    html += `</div></div>`;
  });

  document.getElementById("result").innerHTML = html;
}
</script>
</body>
</html>
