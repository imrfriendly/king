<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>即時業績儀表板</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  :root {
    --primary-bg: #f8f9fa;
    --card-bg: #ffffff;
    --text-primary: #2c3e50;
    --accent-color: #3498db;
    --success-color: #2ecc71;
    --warning-color: #f1c40f;
  }

  body {
    background-color: var(--primary-bg);
    font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
    color: var(--text-primary);
  }

  /* 登入層 */
  #login-section {
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  .login-card {
    background: rgba(255, 255, 255, 0.95);
    padding: 2.5rem;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    width: 100%;
    max-width: 400px;
    text-align: center;
  }

  /* 主儀表板 */
  #dashboard-section { display: none; padding-bottom: 50px; }
  
  .navbar-custom {
    background: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    padding: 1rem;
  }
  .page-title { font-weight: 800; color: #34495e; margin: 0; }

  /* 篩選區塊 */
  .filter-bar {
    background: #fff;
    margin: 20px auto;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.02);
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: end;
  }

  /* 數據卡片 */
  .kpi-card {
    background: #fff;
    border-radius: 15px;
    padding: 20px;
    border: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.02);
    transition: transform 0.2s;
    height: 100%;
    position: relative;
    overflow: hidden;
  }
  .kpi-card:hover { transform: translateY(-3px); }
  .kpi-card::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px;
  }
  .kpi-total::before { background: var(--accent-color); }
  .kpi-count::before { background: var(--success-color); }
  .kpi-qty::before { background: var(--warning-color); }

  .kpi-label { font-size: 0.9rem; color: #95a5a6; font-weight: 600; text-transform: uppercase; }
  .kpi-value { font-size: 2rem; font-weight: 800; color: #2c3e50; margin-top: 5px; }
  .kpi-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 3rem; opacity: 0.1; }

  /* 圖表與表格區 */
  .content-card {
    background: #fff;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.02);
  }
  .card-header-custom {
    font-weight: 700; font-size: 1.1rem; margin-bottom: 15px; border-left: 4px solid #667eea; padding-left: 10px;
  }

  .table-custom th { background: #f8f9fa; font-weight: 600; }
  .table-custom td { vertical-align: middle; }

  /* Loading */
  .loading-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.8); z-index: 9999;
    display: none; align-items: center; justify-content: center; flex-direction: column;
    backdrop-filter: blur(5px);
  }
  .loading-spinner {
    width: 3rem; height: 3rem; border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea; border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  @media(max-width: 768px) {
    .filter-bar { flex-direction: column; }
    .filter-bar > div, .filter-bar > button { width: 100%; }
  }
</style>
</head>
<body>

<div id="login-section">
  <div class="login-card">
    <div class="mb-4">
      <i class="fa-solid fa-chart-line fa-3x text-primary"></i>
    </div>
    <h3 class="fw-bold mb-4">業績儀表板</h3>
    <input type="password" id="inpPassword" class="form-control form-control-lg mb-3" placeholder="請輸入訪問密碼">
    <button onclick="doLogin()" class="btn btn-primary btn-lg w-100 fw-bold">登 入</button>
  </div>
</div>

<div id="dashboard-section">
  <div class="navbar-custom d-flex justify-content-between align-items-center sticky-top">
    <h4 class="page-title"><i class="fa-solid fa-store me-2"></i>即時業績總覽</h4>
    <button onclick="logout()" class="btn btn-outline-danger btn-sm"><i class="fa-solid fa-right-from-bracket"></i></button>
  </div>

  <div class="container-fluid px-lg-5">
    
    <div class="filter-bar">
      <div style="flex: 1;">
        <label class="form-label small fw-bold text-muted">開始日期</label>
        <input type="date" id="startDate" class="form-control">
      </div>
      <div style="flex: 1;">
        <label class="form-label small fw-bold text-muted">結束日期</label>
        <input type="date" id="endDate" class="form-control">
      </div>
      <button onclick="fetchData()" class="btn btn-primary fw-bold px-4" style="height: 38px;">
        <i class="fa-solid fa-magnifying-glass me-2"></i>查詢
      </button>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-md-4">
        <div class="kpi-card kpi-total">
          <div class="kpi-label">總營業額 (Total Sales)</div>
          <div class="kpi-value text-primary" id="kpi-total">$0</div>
          <i class="fa-solid fa-sack-dollar kpi-icon"></i>
        </div>
      </div>
      <div class="col-md-4">
        <div class="kpi-card kpi-count">
          <div class="kpi-label">總交易筆數 (Transactions)</div>
          <div class="kpi-value text-success" id="kpi-count">0</div>
          <i class="fa-solid fa-receipt kpi-icon"></i>
        </div>
      </div>
      <div class="col-md-4">
        <div class="kpi-card kpi-qty">
          <div class="kpi-label">總銷售件數 (Quantity)</div>
          <div class="kpi-value text-warning" id="kpi-qty">0</div>
          <i class="fa-solid fa-shirt kpi-icon"></i>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-5 mb-4">
        <div class="content-card h-100">
          <div class="card-header-custom">門市業績佔比</div>
          <canvas id="salesChart"></canvas>
        </div>
      </div>

      <div class="col-lg-7 mb-4">
        <div class="content-card h-100">
          <div class="card-header-custom">各店詳細數據</div>
          <div class="table-responsive">
            <table class="table table-custom table-hover">
              <thead>
                <tr>
                  <th>門市名稱</th>
                  <th class="text-end">筆數</th>
                  <th class="text-end">件數</th>
                  <th class="text-end">營業額</th>
                  <th>銷售人員</th>
                </tr>
              </thead>
              <tbody id="table-body">
                </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  
  </div>
</div>

<div class="loading-overlay" id="loading">
  <div class="loading-spinner mb-3"></div>
  <div class="fw-bold text-muted">資料讀取中，請稍候...</div>
</div>

<script>
  // ==========================================
  // ⚠️ 請填入您的 GAS 部署網址 (exec 結尾)
  // ==========================================
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzzeldQQQxhFEFTjlB250nRxSTyDzQzgEEPukZAbm4dzfpUAPK_g5W_RP30ScyNggHviw/exec"; 

  // 初始化日期
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('startDate').value = today;
  document.getElementById('endDate').value = today;

  // Chart 實例
  let myChart = null;

  // 登入邏輯
  function doLogin() {
    const pw = document.getElementById('inpPassword').value;
    if(!pw) return Swal.fire('請輸入密碼');

    showLoading(true);
    callApi({ op: 'login', pw: pw }).then(res => {
      showLoading(false);
      if(res.status === 'success') {
        localStorage.setItem('dashboard_pw', pw);
        switchView('dashboard');
        fetchData(); // 登入成功後自動查詢
      } else {
        Swal.fire('登入失敗', '密碼錯誤', 'error');
      }
    });
  }

  // 自動登入檢查
  window.onload = () => {
    const savedPw = localStorage.getItem('dashboard_pw');
    if(savedPw) {
      document.getElementById('inpPassword').value = savedPw;
      doLogin();
    }
  };

  function logout() {
    localStorage.removeItem('dashboard_pw');
    location.reload();
  }

  // 查詢資料
  function fetchData() {
    const pw = localStorage.getItem('dashboard_pw');
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;

    if(!pw) return logout();

    showLoading(true);
    callApi({ 
      op: 'getSummary', 
      pw: pw, 
      startDate: start, 
      endDate: end 
    }).then(res => {
      showLoading(false);
      if(res.status === 'success') {
        renderDashboard(res.data);
      } else {
        Swal.fire('錯誤', res.msg || '讀取失敗', 'error');
      }
    });
  }

  // 渲染畫面
  function renderDashboard(data) {
    const { rows, grandTotal } = data;

    // 1. 更新 KPI
    animateValue("kpi-total", grandTotal.total, "$");
    animateValue("kpi-count", grandTotal.count, "");
    animateValue("kpi-qty", grandTotal.qty, "");

    // 2. 更新表格
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';
    
    // 依營業額排序
    rows.sort((a,b) => b.total - a.total);

    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="fw-bold text-primary">${r.store}</td>
        <td class="text-end">${fmt(r.count)}</td>
        <td class="text-end">${fmt(r.qty)}</td>
        <td class="text-end fw-bold text-success">$${fmt(r.total)}</td>
        <td class="small text-muted text-truncate" style="max-width: 150px;" title="${r.sales}">${r.sales}</td>
      `;
      tbody.appendChild(tr);
    });

    // 3. 更新圖表
    updateChart(rows);
  }

  function updateChart(rows) {
    const ctx = document.getElementById('salesChart').getContext('2d');
    const labels = rows.map(r => r.store);
    const data = rows.map(r => r.total);

    if(myChart) myChart.destroy();

    myChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: '營業額',
          data: data,
          backgroundColor: [
            'rgba(54, 162, 235, 0.6)',
            'rgba(255, 99, 132, 0.6)',
            'rgba(255, 206, 86, 0.6)',
            'rgba(75, 192, 192, 0.6)'
          ],
          borderColor: [
            'rgba(54, 162, 235, 1)',
            'rgba(255, 99, 132, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // API 呼叫 (使用 POST)
  async function callApi(payload) {
    try {
      const res = await fetch(GAS_API_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      });
      return await res.json();
    } catch (e) {
      console.error(e);
      return { status: 'error', msg: '連線錯誤' };
    }
  }

  // 工具函式
  function switchView(view) {
    document.getElementById('login-section').style.display = view === 'login' ? 'flex' : 'none';
    document.getElementById('dashboard-section').style.display = view === 'dashboard' ? 'block' : 'none';
  }

  function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'flex' : 'none';
  }

  function fmt(n) {
    return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  function animateValue(id, end, prefix) {
    const obj = document.getElementById(id);
    obj.innerText = prefix + fmt(end);
    // 簡單動畫效果可依需求增加
  }

</script>
</body>
</html>